generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id            String     @id @default(auto()) @map("_id") @db.ObjectId
  username      String     @unique
  firstName     String
  lastName      String
  email         String     @unique
  password      String
  isSuperUser   Boolean    @default(false)
  isCapper      Boolean?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  subscriptions Capper[]   @relation("UserSubscriptions", fields: [subscribedToIds], references: [id])
  subscribedToIds String[] @db.ObjectId
  capperProfile Capper?
  imageUrl      String?
  stripeConnectId        String?   // For Cappers' Stripe Connect accounts
  stripeConnectOnboarded Boolean   @default(false)
  payoutEnabled         Boolean   @default(false)
  stripeConnectCountry  String?   
  likedPosts        PostLike[]
  resetToken       String?
  resetTokenExpiry DateTime?
  capperApplications CapperApplication[]
  bets          Bet[]     @relation("UserBets")
  socialLinks   Json?           // Store social links as JSON with this structure:
                               // {
                               //   instagram?: { username: string, url: string },
                               //   x?: { username: string, url: string },
                               //   discord?: { username: string, url: string },
                               //   whatsapp?: { username: string, url: string },
                               //   youtube?: { username: string, url: string }
                               // }
  Subscription Subscription[]
}


// The cappers should only refer to the username from the user model. 
model Capper {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  userId        String         @unique @db.ObjectId
  user          User            @relation(fields: [userId], references: [id])
  bio           String?
  title         String?         // Professional title
  imageUrl      String?         // Profile image
  socialLinks   Json?           // Store social links as JSON with this structure:
                               // {
                               //   instagram?: { username: string, url: string },
                               //   x?: { username: string, url: string },
                               //   discord?: { username: string, url: string },
                               //   whatsapp?: { username: string, url: string },
                               //   youtube?: { username: string, url: string }
                               // }
  tags          String[]        // Keep existing tags
  roi           Float?          // ROI percentage
  subscribers   User[]          @relation("UserSubscriptions", fields: [subscriberIds], references: [id])
  subscriberIds String[]       @db.ObjectId
  posts         CapperPost[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  subscriptions Subscription[]
  profileImage  String?
}
  
// TODO: Add SEO friendly fields. 

// TODO: Add right parameters for capper post 
model CapperPost {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  title         String
  content       String
  imageUrl      String?
  tags          String[]
  bets          String[]
  odds          String[]
  bookmaker     String?
  capperId      String   @db.ObjectId
  productId     String?
  capper        Capper   @relation(fields: [capperId], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  likes         Int      @default(0)
  comments      Int      @default(0)
  likedBy       PostLike[]
  capperBets    Bet[]    @relation("PostBets")
  oddsScreenshot String?
  oddsDate      DateTime?
  units         Float     @default(1)

  @@index([capperId])
  @@index([productId])
}

model Subscription {
  id                   String    @id @default(auto()) @map("_id") @db.ObjectId
  userId               String    @db.ObjectId
  capperId             String    @db.ObjectId
  productId            String    // Store the specific bundle/product ID
  priceId              String    // Store the price ID for the bundle
  status               String    // "active" or "cancelled"
  subscribedAt         DateTime  @default(now())
  expiresAt            DateTime? // Add expiration date
  cancelledAt          DateTime? // Add this field
  capper               Capper    @relation(fields: [capperId], references: [id])
  user                 User      @relation(fields: [userId], references: [id])
  stripeSubscriptionId String?  @unique  // Make it optional with ?
  stripePaymentIntentId String?  // Add this field
  stripeCustomerId     String?   // Add this field
}

model PostLike {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  userId    String     @db.ObjectId
  postId    String     @db.ObjectId
  createdAt DateTime   @default(now())
  post      CapperPost @relation(fields: [postId], references: [id])
  user      User       @relation(fields: [userId], references: [id])

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
}

model CapperApplication {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String   @db.ObjectId
  user            User     @relation(fields: [userId], references: [id])
  sport           String
  experience      String
  monthlyBetAmount String
  yearlyROI       String
  roiVerificationImages String[]
  status          String   @default("PENDING")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

model Bet {
  id        String      @id @default(auto()) @map("_id") @db.ObjectId
  game      String
  units    Float?
  currency  String      @default("USD")
  odds      Float
  date      DateTime
  status    BetStatus   @default(PENDING)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  userId    String      @db.ObjectId
  user      User        @relation("UserBets", fields: [userId], references: [id])
  postId    String?     @db.ObjectId
  post      CapperPost? @relation("PostBets", fields: [postId], references: [id])
  oddsScreenshot String?
  oddsDate      DateTime?

  @@index([userId])
  @@index([postId])
}

enum BetStatus {
  PENDING
  WON
  LOST
}
  